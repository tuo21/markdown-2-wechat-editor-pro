# WeChat Editor Pro 项目优化建议

## 项目概述

这是一个基于 Vue 3 + TypeScript + Vite 构建的微信公众号排版工具，支持 Markdown 实时预览、多主题样式、一键复制等功能。项目整体架构清晰，代码质量良好，但仍有一些可以优化的地方。

---

## 一、安全性优化 (高优先级)

### 1.1 XSS 安全漏洞修复

**问题**：[useMarkdown.ts](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/composables/useMarkdown.ts) 中开启了 `html: true`，允许用户输入原始 HTML，但渲染时未进行净化处理。

**现状**：
```typescript
const md = MarkdownIt({
  html: true,  // 允许 HTML 输入
  breaks: true,
  linkify: true,
});
```

**风险**：用户可能输入恶意脚本，导致 XSS 攻击。

**建议**：虽然项目已安装 `dompurify`，但未使用。应在渲染前对 HTML 进行净化：

```typescript
import DOMPurify from 'dompurify';

const renderMarkdown = (markdown: string): string => {
  const html = md.render(markdown);
  return DOMPurify.sanitize(html, {
    ADD_TAGS: ['section'],  // 微信公众号常用标签
    ADD_ATTR: ['data-*'],   // 允许 data 属性
  });
};
```

---

## 二、代码质量优化 (高优先级)

### 2.1 移除无用文件

**问题**：[HelloWorld.vue](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/components/HelloWorld.vue) 是 Vue 项目模板的示例组件，未在项目中使用。

**建议**：删除此文件。

### 2.2 类型安全改进

**问题**：[App.vue:19-24](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/App.vue#L19-L24) 使用了 `any` 类型：

```typescript
const customThemes = ref<Theme[]>(
  (get(STORAGE_KEYS.THEMES, []) as any[]).map(theme => ({ 
    ...theme, 
    isCustom: true 
  })) as Theme[]
);
```

**建议**：定义更精确的类型或使用类型守卫验证存储数据。

### 2.3 Preview 组件样式元素泄漏

**问题**：[Preview.vue:60-68](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/components/Preview.vue#L60-L68) 在 `onMounted` 中创建 style 元素，但没有在组件卸载时清理。

**建议**：添加 `onUnmounted` 钩子清理 style 元素：

```typescript
import { onMounted, onUnmounted } from 'vue';

onUnmounted(() => {
  if (styleElementRef.value) {
    styleElementRef.value.remove();
  }
});
```

---

## 三、性能优化 (中优先级)

### 3.1 组件懒加载

**问题**：[ThemeEditor.vue](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/components/ThemeEditor.vue) 是一个较大的组件（约 400 行），但只在编辑主题时才需要。

**建议**：使用 `defineAsyncComponent` 懒加载：

```typescript
import { defineAsyncComponent } from 'vue';

const ThemeEditor = defineAsyncComponent(() => 
  import('./ThemeEditor.vue')
);
```

### 3.2 编辑器防抖优化

**问题**：[App.vue:105-113](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/App.vue#L105-L113) 的自动保存使用了防抖，但 Markdown 渲染没有防抖，大量输入时可能造成性能问题。

**建议**：对渲染也添加防抖或使用 `v-model.lazy`。

### 3.3 computed 优化

**问题**：[ThemeEditor.vue:23-32](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/components/ThemeEditor.vue#L23-L32) 的 `editableStyles` 计算属性在每次访问时都会重新计算所有元素。

**建议**：考虑使用 `ref` 存储编辑状态，减少不必要的计算。

---

## 四、用户体验优化 (中优先级)

### 4.1 编辑器增强

**问题**：当前编辑器只是一个简单的 textarea，缺少：
- 快捷键支持（Ctrl+B 加粗、Ctrl+I 斜体等）
- 语法高亮
- 行号显示
- 工具栏快捷插入按钮

**建议**：
1. 添加快捷键支持
2. 考虑集成 CodeMirror 或 Monaco Editor
3. 添加工具栏按钮（加粗、斜体、链接、图片、代码块等）

### 4.2 字数统计优化

**问题**：[Editor.vue:15-17](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/components/Editor.vue#L15-L17) 只统计字符数，对中文用户不够友好。

```typescript
const wordCount = computed(() => {
  return props.modelValue.length;  // 只是字符数
});
```

**建议**：区分中文字数和英文字数：

```typescript
const wordCount = computed(() => {
  const text = props.modelValue;
  const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
  const englishWords = (text.match(/[a-zA-Z]+/g) || []).length;
  return { chinese: chineseChars, english: englishWords, total: chineseChars + englishWords };
});
```

### 4.3 主题导入/导出

**问题**：自定义主题只能本地保存，无法分享或备份。

**建议**：添加主题导出为 JSON 和导入 JSON 功能。

### 4.4 深色模式持久化

**问题**：[App.vue:25](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/App.vue#L25) 的深色模式状态未持久化，刷新后重置。

**建议**：将深色模式偏好保存到 localStorage。

### 4.5 复制失败降级方案

**问题**：[useClipboard.ts](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/composables/useClipboard.ts) 使用 ClipboardItem API，部分旧浏览器不支持。

**建议**：添加降级方案，使用 `document.execCommand('copy')` 作为后备。

---

## 五、功能增强建议 (低优先级)

### 5.1 代码块语法高亮

**建议**：集成 highlight.js 或 Prism.js，为代码块添加语法高亮。

### 5.2 图片上传支持

**建议**：支持图片拖拽上传或粘贴上传，自动转换为 Base64 或上传到图床。

### 5.3 历史记录

**建议**：添加撤销/重做功能，或保存历史版本。

### 5.4 Markdown 扩展语法

**建议**：支持更多 Markdown 扩展语法：
- 表格对齐
- 任务列表
- 脚注
- 数学公式 (KaTeX)
- 流程图 (Mermaid)

---

## 六、工程化优化 (中优先级)

### 6.1 添加 ESLint + Prettier

**问题**：项目缺少代码规范工具。

**建议**：
```bash
npm install -D eslint @typescript-eslint/eslint-plugin @typescript-eslint/parser eslint-plugin-vue prettier
```

### 6.2 添加 Git Hooks

**建议**：使用 husky + lint-staged 在提交前自动检查代码。

### 6.3 添加单元测试

**建议**：使用 Vitest 添加单元测试，特别是：
- `styleConverter.ts` 的 CSS 解析/转换函数
- `useClipboard.ts` 的复制逻辑
- `useStorage.ts` 的存储逻辑

### 6.4 Vite 配置优化

**问题**：[vite.config.ts](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/vite.config.ts) 配置过于简单。

**建议**：
```typescript
export default defineConfig({
  plugins: [vue()],
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'markdown': ['markdown-it'],
          'vendor': ['vue'],
        }
      }
    }
  },
  resolve: {
    alias: {
      '@': '/src',
    }
  }
})
```

---

## 七、代码重复优化

### 7.1 ThemeEditor 组件重构

**问题**：[ThemeEditor.vue](file:///f:/编程/公众号编辑器/markdown%202%20WeChat%20Editor%20Pro/src/components/ThemeEditor.vue) 中颜色选择器代码重复多次（全局、标题、内容块等）。

**建议**：提取为独立的 `ColorInput` 组件：

```vue
<template>
  <div class="space-y-3">
    <label class="text-sm font-medium">{{ label }}</label>
    <div class="flex items-center gap-3">
      <input type="color" :value="modelValue" @input="$emit('update:modelValue', $event.target.value)" />
      <input type="text" :value="modelValue" @input="$emit('update:modelValue', $event.target.value)" />
    </div>
  </div>
</template>
```

### 7.2 样式编辑区块组件化

**建议**：将 ThemeEditor 中的样式编辑区块（标题、内容块、其他）提取为独立的 `StyleBlockEditor` 组件。

---

## 八、优化优先级总结

| 优先级 | 类别 | 优化项 |
|--------|------|--------|
| 🔴 高 | 安全性 | XSS 漏洞修复（DOMPurify） |
| 🔴 高 | 代码质量 | 移除 HelloWorld.vue |
| 🔴 高 | 代码质量 | 修复类型安全问题 |
| 🟡 中 | 性能 | ThemeEditor 懒加载 |
| 🟡 中 | 性能 | Preview 组件内存泄漏修复 |
| 🟡 中 | 用户体验 | 深色模式持久化 |
| 🟡 中 | 工程化 | 添加 ESLint + Prettier |
| 🟢 低 | 功能 | 代码块语法高亮 |
| 🟢 低 | 功能 | 图片上传支持 |
| 🟢 低 | 功能 | 历史记录/撤销重做 |

---

## 九、实施建议

建议按以下顺序实施优化：

1. **第一阶段**：安全性修复（DOMPurify 集成）
2. **第二阶段**：代码清理（移除无用文件、修复类型问题）
3. **第三阶段**：工程化配置（ESLint、Prettier）
4. **第四阶段**：性能优化（懒加载、内存泄漏修复）
5. **第五阶段**：用户体验增强
6. **第六阶段**：功能扩展

---

## 十、总结

WeChat Editor Pro 是一个设计良好的项目，核心功能完整，代码结构清晰。主要优化方向集中在：

1. **安全性**：必须修复 XSS 漏洞
2. **代码质量**：清理无用代码，提升类型安全
3. **工程化**：添加代码规范工具和测试
4. **用户体验**：增强编辑器功能和持久化设置

这些优化将使项目更加健壮、可维护，并提供更好的用户体验。
